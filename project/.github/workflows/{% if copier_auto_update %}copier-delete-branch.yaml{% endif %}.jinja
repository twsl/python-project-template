name: Delete Copier PR branch on close

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
{% if 'road-runner' in github_runner %}{% set github_runner = [github_runner_ghec] %}{% endif %}{% raw %}
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true{% endraw %}

jobs:
  copier-delete-branch:
    name: Copier delete branch
    runs-on: {{ github_runner }}
    permissions:
      contents: write
    steps:
      - name: Delete branch via GitHub API
        uses: actions/github-script@v7
        with:
          script:{% raw %} |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branchRef = 'refs/heads/copier/update';

            try {
              await github.rest.git.deleteRef({ owner, repo, ref: branchRef });
              console.log(`Deleted branch ${branchRef}`);
            } catch (error) {
              if (error.status === 422 || error.status === 404) {
                console.log(`Branch ${branchRef} does not exist or already deleted.`);
              } else {
                throw error;
              }
            }{% endraw %}